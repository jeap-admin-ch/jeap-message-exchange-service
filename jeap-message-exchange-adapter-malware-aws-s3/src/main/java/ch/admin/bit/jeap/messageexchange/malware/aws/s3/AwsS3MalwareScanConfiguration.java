package ch.admin.bit.jeap.messageexchange.malware.aws.s3;

import io.awspring.cloud.autoconfigure.sqs.SqsAsyncClientCustomizer;
import lombok.extern.slf4j.Slf4j;
import org.springframework.boot.autoconfigure.AutoConfiguration;
import org.springframework.boot.autoconfigure.condition.ConditionalOnBooleanProperty;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.context.annotation.Bean;
import org.springframework.util.StringUtils;
import software.amazon.awssdk.auth.credentials.AwsBasicCredentials;
import software.amazon.awssdk.auth.credentials.AwsCredentialsProvider;
import software.amazon.awssdk.auth.credentials.StaticCredentialsProvider;
import software.amazon.awssdk.core.client.config.ClientOverrideConfiguration;
import software.amazon.awssdk.http.nio.netty.NettyNioAsyncHttpClient;
import software.amazon.awssdk.http.nio.netty.ProxyConfiguration;
import software.amazon.awssdk.regions.Region;
import software.amazon.awssdk.retries.StandardRetryStrategy;

import java.net.URI;

@Slf4j
@AutoConfiguration
@ConditionalOnBooleanProperty("jeap.messageexchange.malwarescan.enabled")
public class AwsS3MalwareScanConfiguration {

    @Bean("awsS3MalwareScanConfigProperties")
    @ConfigurationProperties(prefix = "jeap.messageexchange.malwarescan.aws-s3")
    public AwsS3MalwareScanConfigProperties awsS3MalwareScanConfigProperties() {
        return new AwsS3MalwareScanConfigProperties();
    }

    @Bean
    AwsS3MalwareScanResultNotifier awsS3MalwareScanResultNotifier() {
        return new AwsS3MalwareScanResultNotifier();
    }

    @Bean
    AwsS3MalwareScanSQSListener awsS3MalwareScanSQSListener(AwsS3MalwareScanResultNotifier notifier,
                                                            AwsS3MalwareScanConfigProperties configProperties) {
        return new AwsS3MalwareScanSQSListener(notifier, configProperties);
    }

    @Bean
    SqsAsyncClientCustomizer sqsAsyncClientCustomizer(AwsS3MalwareScanConfigProperties configProps,
                                                      AwsCredentialsProvider providedCredentialsProvider) {
        return builder -> {

            var nettyNioAsyncHttpClientBuilder = NettyNioAsyncHttpClient.builder()
                    .connectionTimeout(configProps.getSqsHttpConnectionTimeout())
                    .readTimeout(configProps.getSqsHttpReadTimeout())
                    .writeTimeout(configProps.getSqsHttpWriteTimeout())
                    .proxyConfiguration(ProxyConfiguration.builder()
                            .useEnvironmentVariableValues(configProps.isSqsHttpProxyUseExternallyDefinedSettings())
                            .useSystemPropertyValues(configProps.isSqsHttpProxyUseExternallyDefinedSettings())
                    .build());

            var clientConfigurationOverride = ClientOverrideConfiguration.builder()
                    .apiCallTimeout(configProps.getSqsApiCallTimeout())
                    .apiCallAttemptTimeout(configProps.getSqsApiCallAttemptTimeout())
                    .retryStrategy(StandardRetryStrategy.builder()
                            .maxAttempts(configProps.getSqsApiCallMaxAttempts())
                            .build())
                    .build();

            if (StringUtils.hasText(configProps.getSqsRegion())) {
                log.info("Setting the S3 Malware Scan SQS client to use the configured region '{}'", configProps.getSqsRegion());
                builder.region(Region.of(configProps.getSqsRegion()));
            }
            if (StringUtils.hasText(configProps.getSqsEndpointUrl())) {
                URI sqsEndpointUri = getUri(configProps.getSqsEndpointUrl());
                log.info("Setting the S3 Malware Scan SQS client to use the configured service URI '{}'", sqsEndpointUri);
                builder.endpointOverride(sqsEndpointUri);
            }
            builder
                    .httpClientBuilder(nettyNioAsyncHttpClientBuilder)
                    .overrideConfiguration(clientConfigurationOverride)
                    .credentialsProvider(getCredentialsProvider(configProps, providedCredentialsProvider));

        };
    }

    private AwsCredentialsProvider getCredentialsProvider(AwsS3MalwareScanConfigProperties configProps,
                                                          AwsCredentialsProvider providedCredentialsProvider) {
        if (StringUtils.hasText(configProps.getSqsAccessKeyId()) && StringUtils.hasText(configProps.getSqsSecretAccessKey())) {
            log.info("Using a static AWS credentials provider for the S3 Malware Scan SQS client with the configured credentials.");
            return StaticCredentialsProvider.create(AwsBasicCredentials.create(
                    configProps.getSqsAccessKeyId(), configProps.getSqsSecretAccessKey()));
        } else {
            log.info("Using the provided AWS credentials provider of type '{}' for the S3 Malware Scan SQS client.",
                    providedCredentialsProvider != null ? providedCredentialsProvider.getClass().getSimpleName() : "null");
            return providedCredentialsProvider;
        }
    }

    private URI getUri(String accessUrl) {
        if (accessUrl.startsWith("http:") || accessUrl.startsWith("https:")) {
            return URI.create(accessUrl);
        }
        return URI.create("https://" + accessUrl);
    }

}
