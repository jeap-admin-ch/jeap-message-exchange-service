package ch.admin.bit.jeap.messageexchange.malware.aws.s3;

import io.awspring.cloud.sqs.annotation.SqsListener;
import jakarta.annotation.PostConstruct;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.util.StringUtils;

import java.util.Set;

@Slf4j
@RequiredArgsConstructor
class AwsS3MalwareScanSQSListener {

    private final AwsS3MalwareScanResultNotifier notifier;
    private final AwsS3MalwareScanConfigProperties configProperties;

    @SqsListener(
            queueNames = {"#{@awsS3MalwareScanConfigProperties.sqsQueueUrl}"},
            maxConcurrentMessages = "#{@awsS3MalwareScanConfigProperties.sqsConcurrentMessagesMax}",
            maxMessagesPerPoll = "#{@awsS3MalwareScanConfigProperties.sqsMessagesPerPollMax}",
            pollTimeoutSeconds = "#{@awsS3MalwareScanConfigProperties.sqsPollTimeoutSeconds}",
            messageVisibilitySeconds = "#{@awsS3MalwareScanConfigProperties.sqsMessageVisibilitySeconds}"
    )
    void receiveMessage(AwsS3MalwareScanResultMessage message) {
        if (message == null) {
            log.warn("Ignoring a null S3 malware scan result message.");
            return;
        }
        if (!StringUtils.hasText(message.objectKey()) || !StringUtils.hasText(message.bucketName()) || message.scanResult() == null) {
            log.warn("Ignoring an invalid S3 malware scan result message: {}", message);
            return;
        }
        log.debug("Received an S3 malware scan result message for the object with the key '{}' in the bucket '{}': {}",
                message.objectKey(), message.bucketName(), message.scanResult());
        Set<String> restrictNotificationsToBucketNames = configProperties.getRestrictNotifyingMalwareScanResultsToBuckets();
        if (restrictNotificationsToBucketNames.isEmpty() || restrictNotificationsToBucketNames.contains(message.bucketName())) {
            notifier.notifyResult(message.objectKey(), message.bucketName(), message.scanResult());
        } else {
            log.debug("S3 malware scan result message for bucket '{}' ignored." , message.bucketName());
        }
    }

    @PostConstruct
    void logInfo() {
        log.info("S3 malware scan result message listener is listening to the SQS queue {}",
                configProperties.getSqsQueueUrl());
    }

}
