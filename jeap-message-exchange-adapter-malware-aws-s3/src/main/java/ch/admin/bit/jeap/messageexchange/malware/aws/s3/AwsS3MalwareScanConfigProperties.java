package ch.admin.bit.jeap.messageexchange.malware.aws.s3;

import jakarta.annotation.PostConstruct;
import jakarta.validation.constraints.*;

import lombok.Data;
import lombok.ToString;
import org.springframework.validation.annotation.Validated;

import java.time.Duration;
import java.util.Set;

@Data
@Validated
public class AwsS3MalwareScanConfigProperties {

    /**
     * URL of the SQS queue to poll for malware scan results.
     */
    @NotBlank
    private String sqsQueueUrl;

    /**
     * Maximum number of messages processed concurrently by the listener.
     */
    @Positive
    private Integer sqsConcurrentMessagesMax = 5;

    /**
     * Maximum number of messages retrieved per poll request.
     */
    @Positive
    private Integer sqsMessagesPerPollMax = 5;

    /**
     * Duration in seconds to wait for messages during long polling.
     */
    @PositiveOrZero
    private Integer sqsPollTimeoutSeconds = 10;

    /**
     * Duration in seconds a message remains invisible after being received.
     */
    @Positive
    private Integer sqsMessageVisibilitySeconds = 120;

    /**
     * Timeout for establishing HTTP connections to SQS.
     */
    @NotNull
    private Duration sqsHttpConnectionTimeout = Duration.ofSeconds(5);

    /**
     * Timeout for reading HTTP responses from SQS. Must be longer than the poll timeout.
     */
    @NotNull
    private Duration sqsHttpReadTimeout = Duration.ofSeconds(sqsPollTimeoutSeconds).plus(Duration.ofSeconds(3));

    /**
     * Timeout for writing HTTP requests to SQS.
     */
    @NotNull
    private Duration sqsHttpWriteTimeout = Duration.ofSeconds(30);

    /**
     * Timeout for a single API call attempt to SQS.
     */
    @NotNull
    private Duration sqsApiCallAttemptTimeout = sqsHttpReadTimeout.plus(Duration.ofSeconds(1));

    /**
     * Maximum number of retry attempts for failed API calls.
     */
    @Positive
    private int sqsApiCallMaxAttempts = 3;

    /**
     * Total timeout for an API call including all retry attempts.
     */
    @NotNull
    private Duration sqsApiCallTimeout = sqsApiCallAttemptTimeout
            .multipliedBy(sqsApiCallMaxAttempts)
            .plus(Duration.ofSeconds(sqsApiCallMaxAttempts));

    /**
     * Enable using externally defined HTTP proxy settings (env variables, system properties) for the SQS client.
     */
    private boolean sqsHttpProxyUseExternallyDefinedSettings = true;

    /**
     * Access key id for the SQS service. Leave empty to use the default AWS credentials provider chain.
     */
    @ToString.Exclude
    private String sqsAccessKeyId;

    /**
    * Secret access key for the SQS service. Leave empty to use the default AWS credentials provider chain.
     */
    @ToString.Exclude
    private String sqsSecretAccessKey;

    /**
     * Custom endpoint URL for the SQS service. Leave empty to use the default AWS regional endpoint.
     */
    private String sqsEndpointUrl;

    /**
     * Region for the SQS service. Leave empty to use the default region provider.
     */
    private String sqsRegion;

    /**
     * If set, only notify malware scan messages for the specified bucket names; messages for other buckets are ignored.
     */
    @NotNull
    private Set<String> restrictNotifyingMalwareScanResultsToBuckets = Set.of();

    @PostConstruct
    void validate() {
        if (sqsHttpReadTimeout.compareTo(Duration.ofSeconds(sqsPollTimeoutSeconds)) <= 0) {
            throw new IllegalArgumentException("sqsHttpReadTimeout must be greater than sqsPollTimeoutSeconds");
        }
    }

}
