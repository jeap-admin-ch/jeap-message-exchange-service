package ch.admin.bit.jeap.messageexchange.malware.aws.s3;

import ch.admin.bit.jeap.messageexchange.malware.api.MalwareScanResult;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.junit.jupiter.params.ParameterizedTest;
import org.junit.jupiter.params.provider.Arguments;
import org.junit.jupiter.params.provider.MethodSource;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;

import java.util.Set;
import java.util.stream.Stream;

import static org.mockito.Mockito.*;

@ExtendWith(MockitoExtension.class)
class AwsS3MalwareScanSQSListenerTest {

    @Mock
    private AwsS3MalwareScanResultNotifier notifier;

    @Mock
    private AwsS3MalwareScanConfigProperties configProperties;

    private AwsS3MalwareScanSQSListener listener;

    @BeforeEach
    void setUp() {
        listener = new AwsS3MalwareScanSQSListener(notifier, configProperties);
    }

    @Test
    void receiveMessage_nullMessage_shouldIgnoreAndNotCallNotifier() {
        // When
        listener.receiveMessage(null);

        // Then
        verifyNoInteractions(notifier);
    }

    @ParameterizedTest(name = "[{index}] {0}")
    @MethodSource("provideInvalidMessages")
    void receiveMessage_invalidMessage_shouldIgnoreAndNotCallNotifier(
            String testName, // for better test case identification
            AwsS3MalwareScanResultMessage message) {
        // When
        listener.receiveMessage(message);

        // Then
        verifyNoInteractions(notifier);
    }

    @Test
    void receiveMessage_validMessage_shouldCallNotifierCorrectly() {
        // Given
        String objectKey = "test-object-key";
        String bucketName = "test-bucket";
        MalwareScanResult scanResult = MalwareScanResult.NO_THREATS_FOUND;

        when(configProperties.getRestrictNotifyingMalwareScanResultsToBuckets()).thenReturn(
                Set.of("dummy-bucket-a", bucketName, "dummy-bucket-b"));

        AwsS3MalwareScanResultMessage message = AwsS3MalwareScanResultMessage.builder()
                .objectKey(objectKey)
                .bucketName(bucketName)
                .scanResult(scanResult)
                .build();

        // When
        listener.receiveMessage(message);

        // Then
        verify(notifier).notifyResult(objectKey, bucketName, scanResult);
        verifyNoMoreInteractions(notifier);
    }

    @Test
    void receiveMessage_emptyRestrictionSet_shouldNotifyForAnyBucket() {
        // Given - empty set means no restriction, notify all buckets
        String objectKey = "test-object-key";
        String bucketName = "any-bucket";
        MalwareScanResult scanResult = MalwareScanResult.NO_THREATS_FOUND;

        when(configProperties.getRestrictNotifyingMalwareScanResultsToBuckets()).thenReturn(Set.of());

        AwsS3MalwareScanResultMessage message = AwsS3MalwareScanResultMessage.builder()
                .objectKey(objectKey)
                .bucketName(bucketName)
                .scanResult(scanResult)
                .build();

        // When
        listener.receiveMessage(message);

        // Then
        verify(notifier).notifyResult(objectKey, bucketName, scanResult);
        verifyNoMoreInteractions(notifier);
    }

    @Test
    void receiveMessage_bucketNotInRestrictionSet_shouldNotCallNotifier() {
        // Given - buckets not in the restriction set should be ignored
        String objectKey = "test-object-key";
        String bucketName = "unconfigured-bucket";
        MalwareScanResult scanResult = MalwareScanResult.NO_THREATS_FOUND;

        when(configProperties.getRestrictNotifyingMalwareScanResultsToBuckets()).thenReturn(
                Set.of("allowed-bucket-a", "allowed-bucket-b"));

        AwsS3MalwareScanResultMessage message = AwsS3MalwareScanResultMessage.builder()
                .objectKey(objectKey)
                .bucketName(bucketName)
                .scanResult(scanResult)
                .build();

        // When
        listener.receiveMessage(message);

        // Then
        verifyNoInteractions(notifier);
    }

    @Test
    void receiveMessage_bucketInRestrictionSet_shouldCallNotifier() {
        // Given - bucket is in the restriction set, so it should be notified
        String objectKey = "test-object-key";
        String bucketName = "allowed-bucket";
        MalwareScanResult scanResult = MalwareScanResult.THREATS_FOUND;

        when(configProperties.getRestrictNotifyingMalwareScanResultsToBuckets()).thenReturn(
                Set.of("allowed-bucket", "another-allowed-bucket"));

        AwsS3MalwareScanResultMessage message = AwsS3MalwareScanResultMessage.builder()
                .objectKey(objectKey)
                .bucketName(bucketName)
                .scanResult(scanResult)
                .build();

        // When
        listener.receiveMessage(message);

        // Then
        verify(notifier).notifyResult(objectKey, bucketName, scanResult);
        verifyNoMoreInteractions(notifier);
    }

    @Test
    void receiveMessage_multipleMessages_onlyAllowedBucketsNotified() {
        // Given - restriction set has specific buckets
        when(configProperties.getRestrictNotifyingMalwareScanResultsToBuckets()).thenReturn(
                Set.of("bucket-a", "bucket-c"));

        String objectKey = "test-object-key";
        MalwareScanResult scanResult = MalwareScanResult.NO_THREATS_FOUND;

        // Message for bucket-a (in restriction set)
        AwsS3MalwareScanResultMessage messageA = AwsS3MalwareScanResultMessage.builder()
                .objectKey(objectKey)
                .bucketName("bucket-a")
                .scanResult(scanResult)
                .build();

        // Message for bucket-b (not in restriction set)
        AwsS3MalwareScanResultMessage messageB = AwsS3MalwareScanResultMessage.builder()
                .objectKey(objectKey)
                .bucketName("bucket-b")
                .scanResult(scanResult)
                .build();

        // Message for allowed bucket-c (in restriction set)
        AwsS3MalwareScanResultMessage messageC = AwsS3MalwareScanResultMessage.builder()
                .objectKey(objectKey)
                .bucketName("bucket-c")
                .scanResult(scanResult)
                .build();

        // When
        listener.receiveMessage(messageA);
        listener.receiveMessage(messageB);
        listener.receiveMessage(messageC);

        // Then - only bucket-a and bucket-c should be notified
        verify(notifier).notifyResult(objectKey, "bucket-a", scanResult);
        verify(notifier).notifyResult(objectKey, "bucket-c", scanResult);
        verifyNoMoreInteractions(notifier);
    }

    private static Stream<Arguments> provideInvalidMessages() {
        return Stream.of(
                Arguments.of(
                        "null objectKey",
                        AwsS3MalwareScanResultMessage.builder()
                                .objectKey(null)
                                .bucketName("test-bucket")
                                .scanResult(MalwareScanResult.NO_THREATS_FOUND)
                                .build()
                ),
                Arguments.of(
                        "empty objectKey",
                        AwsS3MalwareScanResultMessage.builder()
                                .objectKey("")
                                .bucketName("test-bucket")
                                .scanResult(MalwareScanResult.NO_THREATS_FOUND)
                                .build()
                ),
                Arguments.of(
                        "blank objectKey",
                        AwsS3MalwareScanResultMessage.builder()
                                .objectKey("   ")
                                .bucketName("test-bucket")
                                .scanResult(MalwareScanResult.NO_THREATS_FOUND)
                                .build()
                ),
                Arguments.of(
                        "null bucketName",
                        AwsS3MalwareScanResultMessage.builder()
                                .objectKey("test-key")
                                .bucketName(null)
                                .scanResult(MalwareScanResult.NO_THREATS_FOUND)
                                .build()
                ),
                Arguments.of(
                        "empty bucketName",
                        AwsS3MalwareScanResultMessage.builder()
                                .objectKey("test-key")
                                .bucketName("")
                                .scanResult(MalwareScanResult.NO_THREATS_FOUND)
                                .build()
                ),
                Arguments.of(
                        "blank bucketName",
                        AwsS3MalwareScanResultMessage.builder()
                                .objectKey("test-key")
                                .bucketName("   ")
                                .scanResult(MalwareScanResult.NO_THREATS_FOUND)
                                .build()
                ),
                Arguments.of(
                        "null scanResult",
                        AwsS3MalwareScanResultMessage.builder()
                                .objectKey("test-key")
                                .bucketName("test-bucket")
                                .scanResult(null)
                                .build()
                ),
                Arguments.of(
                        "null objectKey and bucketName",
                        AwsS3MalwareScanResultMessage.builder()
                                .objectKey(null)
                                .bucketName(null)
                                .scanResult(MalwareScanResult.NO_THREATS_FOUND)
                                .build()
                ),
                Arguments.of(
                        "all fields null",
                        AwsS3MalwareScanResultMessage.builder()
                                .objectKey(null)
                                .bucketName(null)
                                .scanResult(null)
                                .build()
                )
        );
    }
}
