package ch.admin.bit.jeap.messageexchange.malware.api;

import org.junit.jupiter.api.Test;

import static org.mockito.ArgumentMatchers.any;
import static org.mockito.ArgumentMatchers.anyString;
import static org.mockito.Mockito.doThrow;
import static org.mockito.Mockito.mock;
import static org.mockito.Mockito.verify;

class MalwareScanResultNotifierTest {

    @Test
    void notifyListeners() {
        MalwareScanResultNotifier notifier = new MalwareScanResultNotifier() {
        };

        MalwareScanResultListener listener1 = mock(MalwareScanResultListener.class);
        MalwareScanResultListener listener2 = mock(MalwareScanResultListener.class);

        notifier.subscribe(listener1);
        notifier.subscribe(listener2);

        String key = "myKey";
        String bucketName = "myBucket";
        MalwareScanResult scanResult = MalwareScanResult.NO_THREATS_FOUND;
        notifier.notifyListeners(key, bucketName, scanResult);

        verify(listener1).onMalwareScanResult(key, bucketName, scanResult);
        verify(listener2).onMalwareScanResult(key, bucketName, scanResult);
    }

    @Test
    void notifyListeners_listener1WithException() {
        MalwareScanResultNotifier notifier = new MalwareScanResultNotifier() {
        };

        MalwareScanResultListener listener1 = mock(MalwareScanResultListener.class);
        doThrow(new RuntimeException("Listener 1 exception")).when(listener1).onMalwareScanResult(anyString(), anyString(), any(MalwareScanResult.class));
        MalwareScanResultListener listener2 = mock(MalwareScanResultListener.class);

        notifier.subscribe(listener1);
        notifier.subscribe(listener2);

        String key = "myKey";
        String bucketName = "myBucket";
        MalwareScanResult scanResult = MalwareScanResult.NO_THREATS_FOUND;
        notifier.notifyListeners(key, bucketName, scanResult);

        verify(listener1).onMalwareScanResult(key, bucketName, scanResult);
        verify(listener2).onMalwareScanResult(key, bucketName, scanResult);
    }
}
