package ch.admin.bit.jeap.messageexchange.malware.nivel.s3;

import io.awspring.cloud.sqs.operations.SqsTemplate;
import lombok.SneakyThrows;
import org.junit.jupiter.api.BeforeAll;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.testcontainers.service.connection.ServiceConnection;
import org.springframework.context.annotation.Import;
import org.springframework.test.annotation.DirtiesContext;
import org.springframework.test.context.DynamicPropertyRegistry;
import org.springframework.test.context.DynamicPropertySource;
import org.testcontainers.containers.localstack.LocalStackContainer;
import org.testcontainers.junit.jupiter.Container;
import org.testcontainers.junit.jupiter.Testcontainers;
import org.testcontainers.utility.DockerImageName;

import java.time.Duration;

import static ch.admin.bit.jeap.messageexchange.malware.api.MalwareScanResult.*;
import static org.awaitility.Awaitility.await;

// Ensure the SQS listener is shut down before the container is stopped to avoid connection issues during shutdown
@DirtiesContext(classMode = DirtiesContext.ClassMode.AFTER_CLASS)
@Testcontainers
@SpringBootTest
@Import(NivelS3MalwareScanTestConfiguration.class)
class NivelS3MalwareScanSQSListenerIT {

    private static final String QUEUE_NAME = "nivel-s3-malwarescan-queue";

    @Container
    @ServiceConnection
    private static final LocalStackContainer LOCAL_STACK =
            new LocalStackContainer(DockerImageName.parse("localstack/localstack:4.10.0")
                    .asCompatibleSubstituteFor("localstack/localstack"))
                    .withServices(LocalStackContainer.Service.SQS)
                    // Disable features that require an internet connection
                    .withEnv("DISABLE_EVENTS", "1")
                    .withEnv("SKIP_INFRA_DOWNLOADS", "1")
                    .withEnv("SKIP_SSL_CERT_DOWNLOAD", "1");

    @Autowired
    private TestMalwareScanResultListener testMalwareScanResultListener;

    @Autowired
    private SqsTemplate sqsTemplateInj;

    @Value("${jeap.messageexchange.malwarescan.nivel-s3.sqs-queue-url}")
    private String sqsQueueUrl;

    @BeforeAll
    @SneakyThrows
    static void setup() {
        LOCAL_STACK.execInContainer("awslocal", "sqs", "create-queue", "--queue-name", QUEUE_NAME);
    }

    @Test
    void testReceiveMessage() {
        final String key = "test-object-key";
        final String bucket = "test-bucket-name";
        NivelS3MalwareScanResultMessage message = NivelS3MalwareScanResultMessage.builder()
                .objectKey(key)
                .bucketName(bucket)
                .scanResult(NO_THREATS_FOUND)
                .build();
        sqsTemplateInj.send(sqsQueueUrl, message);

        await().atMost(Duration.ofSeconds(30)).
                until( () ->
                       testMalwareScanResultListener.
                               getResult(key, bucket) != null);
    }

    @DynamicPropertySource
    static void setUpAwsSqsProperties(DynamicPropertyRegistry registry) {
        registry.add("jeap.messageexchange.malwarescan.nivel-s3.sqs-queue-url", () ->  QUEUE_NAME);
    }

}
