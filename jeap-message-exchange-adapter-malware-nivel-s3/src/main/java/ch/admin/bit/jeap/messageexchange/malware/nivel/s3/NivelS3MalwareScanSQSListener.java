package ch.admin.bit.jeap.messageexchange.malware.nivel.s3;

import io.awspring.cloud.sqs.annotation.SqsListener;
import jakarta.annotation.PostConstruct;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.util.StringUtils;

import java.util.Set;

@Slf4j
@RequiredArgsConstructor
class NivelS3MalwareScanSQSListener {

    private final NivelS3MalwareScanResultNotifier notifier;
    private final NivelS3MalwareScanConfigProperties configProperties;

    @SqsListener(
            queueNames = {"#{@nivelS3MalwareScanConfigProperties.sqsQueueUrl}"},
            maxConcurrentMessages = "#{@nivelS3MalwareScanConfigProperties.sqsConcurrentMessagesMax}",
            maxMessagesPerPoll = "#{@nivelS3MalwareScanConfigProperties.sqsMessagesPerPollMax}",
            pollTimeoutSeconds = "#{@nivelS3MalwareScanConfigProperties.sqsPollTimeoutSeconds}",
            messageVisibilitySeconds = "#{@nivelS3MalwareScanConfigProperties.sqsMessageVisibilitySeconds}"
    )
    void receiveMessage(NivelS3MalwareScanResultMessage message) {
        if (message == null) {
            log.warn("Ignoring a null Nivel S3 malware scan result message.");
            return;
        }
        if (!StringUtils.hasText(message.objectKey()) || !StringUtils.hasText(message.bucketName()) || message.scanResult() == null) {
            log.warn("Ignoring an invalid Nivel S3 malware scan result message: {}", message);
            return;
        }
        log.debug("Received a Nivel S3 malware scan result message for the object with the key '{}' in the bucket '{}': {}",
                message.objectKey(), message.bucketName(), message.scanResult());
        Set<String> restrictNotificationsToBucketNames = configProperties.getRestrictNotifyingMalwareScanResultsToBuckets();
        if (restrictNotificationsToBucketNames.isEmpty() || restrictNotificationsToBucketNames.contains(message.bucketName())) {
            notifier.notifyResult(message.objectKey(), message.bucketName(), message.scanResult());
        } else {
            log.debug("Nivel S3 malware scan result message for bucket '{}' ignored." , message.bucketName());
        }
    }

    @PostConstruct
    void logInfo() {
        log.info("Nivel S3 malware scan result message listener is listening to the SQS queue {}",
                configProperties.getSqsQueueUrl());
    }

}
