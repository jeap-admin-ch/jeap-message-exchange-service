package ch.admin.bit.jeap.messageexchange.domain.malwarescan;

import ch.admin.bit.jeap.messageexchange.domain.MessageExchangeService;
import ch.admin.bit.jeap.messageexchange.malware.api.MalwareScanResult;
import ch.admin.bit.jeap.messageexchange.malware.api.MalwareScanResultNotifier;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.ArgumentCaptor;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;

import java.util.Optional;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertThrows;
import static org.mockito.Mockito.mock;
import static org.mockito.Mockito.verify;

@ExtendWith(MockitoExtension.class)
class S3ObjectMalwareScannedEventListenerTest {

    @Mock
    private MessageExchangeService messageExchangeService;

    @Test
    void init_throwException_whenNotifierNotSet() {
        Optional<MalwareScanResultNotifier> notifier = Optional.empty();
        S3ObjectMalwareScannedEventListener listener = new S3ObjectMalwareScannedEventListener(messageExchangeService, notifier);

        assertThrows(IllegalStateException.class, listener::init);
    }

    @Test
    void init_ok_whenNotifierSet() {
        MalwareScanResultNotifier notifier = mock(MalwareScanResultNotifier.class);
        Optional<MalwareScanResultNotifier> notifierOptional = Optional.of(notifier);
        S3ObjectMalwareScannedEventListener listener = new S3ObjectMalwareScannedEventListener(messageExchangeService, notifierOptional);

        listener.init();

        verify(notifier).subscribe(listener);
    }

    @Test
    void onMalwareScanResult() {
        MalwareScanResultNotifier notifier = mock(MalwareScanResultNotifier.class);
        Optional<MalwareScanResultNotifier> notifierOptional = Optional.of(notifier);
        S3ObjectMalwareScannedEventListener listener = new S3ObjectMalwareScannedEventListener(messageExchangeService, notifierOptional);

        String key = "key1";
        String bucketName = "bucket1";
        MalwareScanResult scanResult = MalwareScanResult.NO_THREATS_FOUND;

        listener.onMalwareScanResult(key, bucketName, scanResult);

        ArgumentCaptor<S3ObjectMalwareScanResultInfo> captor = ArgumentCaptor.forClass(S3ObjectMalwareScanResultInfo.class);

        verify(messageExchangeService).onMalwareScanResult(captor.capture());
        S3ObjectMalwareScanResultInfo scanResultInfo = captor.getValue();

        assertEquals(key, scanResultInfo.objectKey());
        assertEquals(bucketName, scanResultInfo.bucketName());
        assertEquals(scanResult, scanResultInfo.scanResult());
    }
}
